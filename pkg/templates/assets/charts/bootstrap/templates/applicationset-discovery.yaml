{{- if .Values.discovery.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: app-discovery
  namespace: {{ .Values.argocd.namespace }}
  labels:
    project: {{ .Values.project }}
    tier: applications
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  
  generators:
  - scmProvider:
      {{- if eq .Values.discovery.scmProvider "github" }}
      github:
        organization: {{ .Values.discovery.organization }}
        tokenRef:
          secretName: {{ .Values.discovery.tokenSecretName }}
          key: {{ .Values.discovery.tokenSecretKey }}
        allBranches: false
      {{- else if eq .Values.discovery.scmProvider "gitlab" }}
      gitlab:
        group: {{ .Values.discovery.organization }}
        tokenRef:
          secretName: {{ .Values.discovery.tokenSecretName }}
          key: {{ .Values.discovery.tokenSecretKey }}
        allBranches: false
      {{- end }}
      filters:
      # Filtro: Repos com o tópico específico
      - repositoryMatch: ".*"
        labelMatch: {{ .Values.discovery.topic }}
      # Filtro: Apenas branch principal
      - branchMatch: "{{ .Values.git.branch }}"
      # Filtro: Deve ter pasta infra/
      - pathsExist: ["infra"]
  
  template:
    metadata:
      name: '{{`{{ .repository }}`}}'
      labels:
        project: {{ .Values.project }}
        tier: applications
        source: discovery
    spec:
      project: {{ .Values.project }}
      
      source:
        repoURL: '{{`{{ .url }}`}}'
        targetRevision: '{{`{{ .branch }}`}}'
        path: infra
        
      destination:
        server: {{ .Values.argocd.destinationServer }}
        namespace: '{{`{{ .repository }}`}}'
        
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
          allowEmpty: false
        syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        
        retry:
          limit: 3
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 1m
{{- end }}
