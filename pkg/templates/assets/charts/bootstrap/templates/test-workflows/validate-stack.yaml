apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: validate-stack
  namespace: argocd
  labels:
    project: {{ .Values.project }}
    component: validation
spec:
  entrypoint: validate
  serviceAccountName: argo-workflow-executor
  
  templates:
  - name: validate
    steps:
    - - name: validate-resources
        template: resource-validation
    - - name: validate-networking
        template: network-validation
    - - name: validate-security
        template: security-validation
  
  - name: resource-validation
    script:
      image: bitnami/kubectl:latest
      command: [bash]
      source: |
        #!/bin/bash
        set -euo pipefail
        echo "üìä Validando recursos do cluster..."
        
        # Verificar se namespaces essenciais existem
        for ns in argocd argo argo-events; do
          kubectl get namespace $ns || { echo "‚ùå Namespace $ns n√£o encontrado"; exit 1; }
        done
        
        # Verificar pods em estado Running
        FAILED_PODS=$(kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded -o json | jq '.items | length')
        if [ "$FAILED_PODS" -gt 0 ]; then
          echo "‚ö†Ô∏è  $FAILED_PODS pods n√£o est√£o em estado saud√°vel"
          kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded
        else
          echo "‚úÖ Todos os pods est√£o saud√°veis"
        fi
  
  - name: network-validation
    script:
      image: bitnami/kubectl:latest
      command: [bash]
      source: |
        #!/bin/bash
        set -euo pipefail
        echo "üåê Validando networking..."
        
        # Verificar services
        kubectl get svc --all-namespaces | head -n 20
        
        # Verificar se webhook service est√° exposto
        WEBHOOK_SVC=$(kubectl get svc git-webhook-eventsource-svc -n argo-events -o jsonpath='{.spec.type}' 2>/dev/null || echo '')
        if [ "$WEBHOOK_SVC" = "NodePort" ]; then
          echo "‚úÖ Webhook service exposto via NodePort"
        else
          echo "‚ö†Ô∏è  Webhook service n√£o est√° em NodePort (n√£o bloqueante)"
        fi
  
  - name: security-validation
    script:
      image: bitnami/kubectl:latest
      command: [bash]
      source: |
        #!/bin/bash
        set -euo pipefail
        echo "üîí Validando seguran√ßa..."
        
        # Verificar se Sealed Secrets est√° instalado
        kubectl get pods -n sealed-secrets || echo "‚ö†Ô∏è  Sealed Secrets n√£o instalado"
        
        # Verificar ServiceAccounts
        kubectl get sa argo-workflow-executor -n argocd || echo "‚ö†Ô∏è  ServiceAccount argo-workflow-executor n√£o encontrado"
        
        echo "‚úÖ Valida√ß√£o de seguran√ßa completa"
