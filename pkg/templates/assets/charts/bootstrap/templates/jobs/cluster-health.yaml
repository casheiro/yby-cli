apiVersion: batch/v1
kind: CronJob
metadata:
  name: cluster-health-check
  namespace: argocd
  labels:
    project: {{ .Values.project }}
    component: ops
spec:
  schedule: "*/30 * * * *"  # A cada 30 minutos
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: argo-workflow-executor
          restartPolicy: OnFailure
          containers:
          - name: health-check
            image: bitnami/kubectl:latest
            command: [bash, -c]
            args:
            - |
              #!/bin/bash
              set -euo pipefail
              
              echo "üè• Health Check do Cluster - $(date)"
              echo "======================================="
              
              # Verificar nodes
              echo "üìä Nodes:"
              kubectl get nodes
              
              # Verificar pods com problemas
              echo ""
              echo "üîç Pods com problemas:"
              FAILED=$(kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded --no-headers 2>/dev/null | wc -l)
              if [ "$FAILED" -gt 0 ]; then
                echo "‚ö†Ô∏è  $FAILED pods com problemas:"
                kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded
              else
                echo "‚úÖ Todos os pods saud√°veis"
              fi
              
              # Verificar uso de recursos
              echo ""
              echo "üíæ Uso de recursos:"
              kubectl top nodes || echo "‚ö†Ô∏è  Metrics server n√£o dispon√≠vel"
              
              # Verificar Argo CD Applications
              echo ""
              echo "üì¶ Argo CD Applications:"
              kubectl get applications -n argocd -o custom-columns=NAME:.metadata.name,SYNC:.status.sync.status,HEALTH:.status.health.status
              
              echo ""
              echo "‚úÖ Health Check completo"
