# .github/workflows/start-release.yaml
name: "ðŸ¤– AUTO: Start Release Process"

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - develop

jobs:
  start-release:
    # Run on all PR events to satisfy "Required Status Check", but only execute logic conditionally
    # if: github.event.pull_request.merged == true  <-- REMOVED to allow dry-run
    name: "ðŸ¤– AUTO: Start Release"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout develop
        uses: actions/checkout@v4
        with:
          ref: "develop"
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: ðŸ“¦ Install Dependencies
        run: npm install conventional-recommended-bump semver conventional-changelog-conventionalcommits

      - name: ðŸ·ï¸ Calculate Next Version
        id: versioning
        run: |
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "v0.0.0")
          BUMP=$(npx conventional-recommended-bump --preset=conventionalcommits)

          if [ -z "$BUMP" ]; then
            echo "No version bump recommended based on new commits. Nothing to release."
            echo "continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          NEXT_VERSION=$(npx semver -i $BUMP $LATEST_TAG)
          echo "Next version will be: v$NEXT_VERSION"
          echo "release_version=v$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "continue=true" >> $GITHUB_OUTPUT

      - name: ðŸ”® Preview Release (Dry Run)
        if: github.event.pull_request.merged != true && steps.versioning.outputs.continue == 'true'
        run: |
          echo "::notice::âœ… Dry Run Success: Merging this PR will trigger release process for version ${{ steps.versioning.outputs.release_version }}."

      - name: ðŸŒ¿ Create Release Staging Environment
        # Only run actual release logic if merged AND version/bump is valid
        if: github.event.pull_request.merged == true && steps.versioning.outputs.continue == 'true'
        id: create_release_pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ steps.versioning.outputs.release_version }}
        run: |
          RELEASE_BRANCH="release/$RELEASE_VERSION"

          echo "Verificando se a branch '$RELEASE_BRANCH' jÃ¡ existe no remote..."
          if git ls-remote --exit-code --heads origin "$RELEASE_BRANCH"; then
            echo "âœ… A branch de release '$RELEASE_BRANCH' jÃ¡ existe. O PR correspondente serÃ¡ atualizado automaticamente pelo GitHub com os novos commits."
            exit 0 # Exit gracefully
          fi

          echo "Criando a branch de release '$RELEASE_BRANCH' a partir da 'main'..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create the new release branch from the HEAD of the remote main branch (to ensure clean slate)
          # OR from develop? The template said "checkout -b ... origin/main" but then "PR from develop to release".
          # This implies release starts equal to main, and the PR brings in everything from Develop. Correct.
          git checkout -b "$RELEASE_BRANCH" origin/main
          git push origin "$RELEASE_BRANCH"

          # Create a PR from the 'develop' branch into the new 'release' branch
          echo "Criando PR de 'develop' para '$RELEASE_BRANCH'..."
          PR_URL=$(gh pr create \
            --head "develop" \
            --base "$RELEASE_BRANCH" \
            --title "chore: Stage changes for Release $RELEASE_VERSION" \
            --body "Este PR prepara as mudanÃ§as da 'develop' para a release **$RELEASE_VERSION**. O merge deste PR irÃ¡ disparar a automaÃ§Ã£o final da release (criaÃ§Ã£o de Tag e disparo do GoReleaser).")

          echo "Staging PR criado: $PR_URL"

          # Post a comment on the original commit on develop that triggered this workflow
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.event.pull_request.merge_commit_sha }}/comments \
            -f body="âœ… Este merge iniciou ou atualizou o processo da release **$RELEASE_VERSION**. O PR de preparaÃ§Ã£o para esta release Ã©: $PR_URL"
