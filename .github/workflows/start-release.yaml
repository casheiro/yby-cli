# .github/workflows/start-release.yaml
name: "ü§ñ AUTO: Start Release Process"

on:
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  start-release:
    # Only run on merged PRs to the develop branch
    if: github.event.pull_request.merged == true
    name: "ü§ñ AUTO: Start Release"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: üì• Checkout develop
        uses: actions/checkout@v4
        with:
          ref: "develop"
          fetch-depth: 0

      - name: üîß Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: üì¶ Install Dependencies
        run: npm install conventional-recommended-bump semver conventional-changelog-conventionalcommits

      - name: üè∑Ô∏è Calculate Next Version
        id: versioning
        run: |
          LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "v0.0.0")
          BUMP=$(npx conventional-recommended-bump --preset=conventionalcommits)

          if [ -z "$BUMP" ]; then
            echo "No version bump recommended based on new commits. Nothing to release."
            echo "continue=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          NEXT_VERSION=$(npx semver -i $BUMP $LATEST_TAG)
          echo "Next version will be: v$NEXT_VERSION"
          echo "release_version=v$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "continue=true" >> $GITHUB_OUTPUT

      - name: üåø Create Release Staging Environment
        if: steps.versioning.outputs.continue == 'true'
        id: create_release_pr
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ steps.versioning.outputs.release_version }}
        run: |
          RELEASE_BRANCH="release/$RELEASE_VERSION"

          echo "Verificando se a branch '$RELEASE_BRANCH' j√° existe no remote..."
          if git ls-remote --exit-code --heads origin "$RELEASE_BRANCH"; then
            echo "‚úÖ A branch de release '$RELEASE_BRANCH' j√° existe. O PR correspondente ser√° atualizado automaticamente pelo GitHub com os novos commits."
            exit 0 # Exit gracefully
          fi

          echo "Criando a branch de release '$RELEASE_BRANCH' a partir da 'main'..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create the new release branch from the HEAD of the remote main branch (to ensure clean slate)
          # OR from develop? The template said "checkout -b ... origin/main" but then "PR from develop to release".
          # This implies release starts equal to main, and the PR brings in everything from Develop. Correct.
          git checkout -b "$RELEASE_BRANCH" origin/main
          git push origin "$RELEASE_BRANCH"

          # Create a PR from the 'develop' branch into the new 'release' branch
          echo "Criando PR de 'develop' para '$RELEASE_BRANCH'..."
          PR_URL=$(gh pr create \
            --head "develop" \
            --base "$RELEASE_BRANCH" \
            --title "chore: Stage changes for Release $RELEASE_VERSION" \
            --body "Este PR prepara as mudan√ßas da 'develop' para a release **$RELEASE_VERSION**. O merge deste PR ir√° disparar a automa√ß√£o final da release (cria√ß√£o de Tag e disparo do GoReleaser).")

          echo "Staging PR criado: $PR_URL"

          # Post a comment on the original commit on develop that triggered this workflow
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/commits/${{ github.event.pull_request.merge_commit_sha }}/comments \
            -f body="‚úÖ Este merge iniciou ou atualizou o processo da release **$RELEASE_VERSION**. O PR de prepara√ß√£o para esta release √©: $PR_URL"
